const sefirotInfo = {
  כתר: {
    title: "כתר - Crown",
    description:
      "הספירה הגבוהה ביותר, מסמלת את רצון הבורא והכוח העליון. מייצגת את האין סוף ואת המקור הראשוני של כל הבריאה. ישנה מחלוקת בשאלה האם הכתר אכן יכול להיחשב לספירה. שמה מעיד כי אינה חלק אינטגרלי מתוך מערכת הספירות, אלא מעליהם, כמו הכתר שאינו חלק מן הגוף אלא מונח מעליו.",
    color: "#FFFFFF",
    holyName: "אהיה",
    world: "אצילות",
    attributes: {
      צבע: "לבן טהור",
      כינוי: "אהיה אשר אהיה",
      מלאך: "מטטרון - שר הפנים",
      אות: "א",
    },
    angel: "מטטרון",
    tarotCard: "The Fool",
    hebrewLetter: "א",
    bodyConnection: {
      part: "מוח עליון",
      function: "תודעה עליונה",
      chakra: "כתר - Sahasrara",
      healing: "מודעות טהורה",
    },
    pnimiut: {
      title: "פנימיות משולשת",
      aspects: [
        {
          name: "אמונה",
          description: "נקודת החיבור העליונה ביותר של הנשמה עם ה'",
        },
        {
          name: "תענוג",
          description: "אופי וכשרונות ייחודיים של הנשמה בשורשה",
        },
        { name: "רצון", description: "הדחף להגשמת ייעוד הנשמה בעולם" },
      ],
    },
  },
  חכמה: {
    title: "חכמה - Wisdom",
    description:
      "'החכמה מאין תמצא'; החכמה נאצלת מתוך ספירת ה'אין' היא הכתר. ספירה זו היא תחילת המחשבה והתכנון האלוהי של הבריאה. בספירה זו הרצון של הכתר מתגלה, ומופיע רעיון ראשוני, אינטואיטיבי.",
    color: "#4682B4",
    holyName: "י",
    world: "אצילות",
    attributes: {
      צבע: "כחול",
      כינוי: "אב החכמה",
      יסוד: "התבוננות",
      מידה: "ביטול העצמי",
      אות: "י - ראשית ההתגלות",
      מלאך: "רזיאל - שומר סודות התורה",
    },
    angel: "רזיאל",
    tarotCard: "The High Priestess",
    hebrewLetter: "י",
    bodyConnection: {
      part: "המוח הימני",
      function: "חשיבה אינטואיטיבית",
      chakra: "עין שלישית - Ajna",
      healing: "ראייה פנימית",
    },
    pnimiut: {
      title: "ביטול",
      description: "מיעוט העצמי והתבטלות למקור החכמה",
      expression: "היכולת לקבל השראה חדשה",
    },
  },
  בינה: {
    title: "בינה - Understanding",
    description: "הבנה והרחבה של נקודת החכמה.",
    color: "#000000",
    holyName: "יהוה",
    world: "אצילות",
    attributes: {
      צבע: "שחור",
      כינוי: "אם עליונה",
      יסוד: "תשובה",
      מידה: "שמחה",
      אות: "ה - ראשונה - התרחבות והבנה",
      מלאך: "צפקיאל - שר הבינה",
    },
    angel: "צפקיאל",
    tarotCard: "The Hierophant",
    hebrewLetter: "ה",
    bodyConnection: {
      part: "המוח השמאלי",
      function: "חשיבה אנליטית",
      chakra: "עין שלישית - Ajna",
      healing: "הבנה עמוקה",
    },
    pnimiut: {
      title: "שמחה",
      description: "השמחה בהתגבשות והבנת תובנה חדשה",
      expression: "קליטת הרעיון בכלי המחשבה",
    },
  },
  חסד: {
    title: "חסד - Kindness",
    description: "אהבה וחסד בלתי מוגבלים.",
    color: "#FFD700",
    holyName: "אל",
    world: "אצילות",
    attributes: {
      צבע: "לבן-כסף",
      כינוי: "גדולה",
      יסוד: "אהבה",
      מידה: "נדיבות",
      אות: "ח",
      מלאך: "צדקיאל - שר החסד",
    },
    angel: "צדקיאל",
    tarotCard: "The Emperor",
    hebrewLetter: "ח",
    bodyConnection: {
      part: "זרוע ימין",
      function: "נתינה והענקה",
      chakra: "לב - Anahata",
      healing: "אהבה וחמלה",
    },
    pnimiut: {
      title: "אהבה",
      description: "הרגש הפנימי המפעם במעשי החסד",
      expression: "רגש של קירוב וחיבה",
    },
  },
  גבורה: {
    title: "גבורה - Strength",
    description: "דין וגבורה, צמצום והגבלה.",
    color: "#FF4500",
    holyName: "אלהים",
    world: "אצילות",
    attributes: {
      צבע: "אדום",
      כינוי: "פחד",
      יסוד: "יראה",
      מידה: "גבורה",
      אות: "ג",
      מלאך: "כמאל - שר הגבורה",
    },
    angel: "כמאל",
    tarotCard: "The Chariot",
    hebrewLetter: "ג",
    bodyConnection: {
      part: "זרוע שמאל",
      function: "גבול וריסון",
      chakra: "סולר פלקסוס - Manipura",
      healing: "כוח ומשמעת",
    },
    pnimiut: {
      title: "יראה",
      description: "הרגש הפנימי המפעם בפעולות הגבורה",
      expression: "רגש של ריחוק וגבול",
    },
  },
  תפארת: {
    title: "תפארת - Beauty",
    description: "הרמוניה ואיזון בין חסד לדין.",
    color: "#7FFFD4",
    holyName: "יהוה",
    world: "אצילות",
    attributes: {
      צבע: "צהוב",
      כינוי: "אמת",
      יסוד: "רחמים",
      מידה: "אמת",
      אות: "ו",
      מלאך: "רפאל - שר הרפואה",
    },
    angel: "רפאל",
    tarotCard: "The Empress",
    hebrewLetter: "ו",
    bodyConnection: {
      part: "הלב",
      function: "איזון והרמוניה",
      chakra: "לב - Anahata",
      healing: "ריפוי רגשי",
    },
    pnimiut: {
      title: "רחמים",
      description: "שילוב של חסד ודין",
      expression: "דאגה לזולת מתוך ראייה מפוכחת ואהבה",
    },
  },
  נצח: {
    title: "נצח - Victory",
    description: "נצחיות והתמדה.",
    color: "#228B22",
    holyName: "יהוה צבאות",
    world: "אצילות",
    attributes: {
      צבע: "ירוק",
      כינוי: "נצחון",
      יסוד: "נצח",
      מידה: "התמדה",
      אות: "נ",
      מלאך: "הניאל - שר הנצח",
    },
    angel: "הניאל",
    tarotCard: "The Hanged Man",
    hebrewLetter: "נ",
    bodyConnection: {
      part: "רגל ימין",
      function: "התקדמות והתמדה",
      chakra: "מקלעת השמש - Manipura",
      healing: "אנרגיה ומוטיבציה",
    },
    pnimiut: {
      title: "בטחון",
      description: "הכח לנצח נובע מבטחון פעיל בנפש",
      expression: "אמונה ביכולת להצליח",
    },
  },
  הוד: {
    title: "הוד - Splendor",
    description: "הוד והדר, הכנעה והודיה.",
    color: "#FFA500",
    holyName: "אלהים צבאות",
    world: "אצילות",
    attributes: {
      צבע: "כתום",
      כינוי: "הדר",
      יסוד: "הוד",
      מידה: "הדר",
      אות: "ה",
      מלאך: "מיכאל - שר ההוד",
    },
    angel: "מיכאל",
    tarotCard: "The Sun",
    hebrewLetter: "ה",
    bodyConnection: {
      part: "רגל שמאל",
      function: "קבלה והודיה",
      chakra: "בסיס - Muladhara",
      healing: "יציבות וביטחון",
    },
    pnimiut: {
      title: "תמימות",
      description: "היכולת להודות נובעת מאמונה תמימה",
      expression: "קבלה והכרה בטוב",
    },
  },
  יסוד: {
    title: "יסוד - Foundation",
    description: "יסוד וחיבור, העברת השפע.",
    color: "#00008B",
    holyName: "שדי",
    world: "אצילות",
    attributes: {
      צבע: "סגול",
      כינוי: "צדיק",
      יסוד: "יסוד",
      מידה: "חיבור",
      אות: "י",
      מלאך: "גבריאל - שר היסוד",
    },
    angel: "גבריאל",
    tarotCard: "Temperance",
    hebrewLetter: "י",
    bodyConnection: {
      part: "איברי הרבייה",
      function: "יצירה וחיבור",
      chakra: "מין - Svadhisthana",
      healing: "יצירתיות וחיוניות",
    },
    pnimiut: {
      title: "אמת",
      description: "אימות כוחות הנפש במפגש עם המציאות",
      expression: "יכולת ההתקשרות האמיתית",
    },
  },
  מלכות: {
    title: "מלכות - Kingdom",
    description: "מלכות שמים בעולם הזה.",
    color: "#8B0000",
    holyName: "אדני",
    world: "אצילות",
    attributes: {
      צבע: "חום-סגול",
      כינוי: "שכינה",
      יסוד: "מלכות",
      מידה: "מעשה",
      אות: "מ",
      מלאך: "סנדלפון - שר המלכות",
    },
    angel: "סנדלפון",
    tarotCard: "The World",
    hebrewLetter: "מ",
    bodyConnection: {
      part: "כל הגוף",
      function: "ביטוי בעולם החומר",
      chakra: "שורש - Muladhara",
      healing: "חיבור לאדמה",
    },
    pnimiut: {
      title: "שפלות",
      description: "ענווה פנימית למרות המעמד החיצוני",
      expression: "יכולת הקבלה מהספירות העליונות",
    },
  },
};

const modal = document.getElementById("sefira-modal");
const modalTitle = document.getElementById("modal-title");
const modalDescription = document.getElementById("modal-description");
const closeButton = document.querySelector(".close-button");

// הגדרת נתוני הספירות כולל מיקומים
const sefirotData = [
  { id: "כתר", x: 400, y: 50, connections: ["חכמה", "בינה"] },
  { id: "חכמה", x: 250, y: 150, connections: ["כתר", "חסד", "בינה"] },
  { id: "בינה", x: 550, y: 150, connections: ["כתר", "חכמה", "גבורה"] },
  { id: "חסד", x: 200, y: 250, connections: ["חכמה", "תפארת"] },
  { id: "גבורה", x: 600, y: 250, connections: ["בינה", "תפארת"] },
  { id: "תפארת", x: 400, y: 350, connections: ["חסד", "גבורה", "נצח", "הוד"] },
  { id: "נצח", x: 250, y: 450, connections: ["תפארת", "יסוד"] },
  { id: "הוד", x: 550, y: 450, connections: ["תפארת", "יסוד"] },
  { id: "יסוד", x: 400, y: 550, connections: ["נצח", "הוד", "מלכות"] },
  { id: "מלכות", x: 400, y: 650, connections: ["יסוד"] },
];

// יצירת מערך של קשרים
const createConnections = () => {
  const links = [];
  sefirotData.forEach((sefira) => {
    sefira.connections.forEach((target) => {
      links.push({
        source: sefira,
        target: sefirotData.find((s) => s.id === target),
      });
    });
  });
  return links;
};

// יצירת ה-SVG באמצעות D3
function createTree() {
  const width = 800;
  const height = 800;

  const svg = d3
    .select("#tree-svg-container")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("viewBox", [0, 0, width, height]);

  // יצירת הקשרים
  const links = createConnections();
  const linksGroup = svg.append("g").attr("class", "links");

  const lines = linksGroup
    .selectAll("line")
    .data(links)
    .enter()
    .append("line")
    .attr("x1", (d) => d.source.x)
    .attr("y1", (d) => d.source.y)
    .attr("x2", (d) => d.target.x)
    .attr("y2", (d) => d.target.y)
    .attr("stroke", "rgba(0,0,0,0.15)")
    .attr("stroke-width", 2)
    .style("stroke-linecap", "round")
    .attr("stroke-dasharray", function () {
      return this.getTotalLength();
    })
    .attr("stroke-dashoffset", function () {
      return this.getTotalLength();
    });

  // אנימציית הקווים
  lines.transition().duration(1500).attr("stroke-dashoffset", 0);

  // יצירת הספירות
  const nodes = svg
    .append("g")
    .attr("class", "nodes")
    .selectAll("g")
    .data(sefirotData)
    .enter()
    .append("g")
    .attr("transform", (d) => `translate(${d.x},${d.y})`)
    .attr("class", "sefira-group")
    .style("opacity", 0);

  // הוספת העיגולים
  nodes
    .append("circle")
    .attr("r", 40)
    .attr("class", (d) => `circle ${d.id}-circle`)
    .style("fill", "white")
    .style("stroke", (d) => sefirotInfo[d.id].color)
    .style("stroke-width", 3);

  // הוספת הטקסט
  nodes
    .append("text")
    .text((d) => d.id)
    .attr("text-anchor", "middle")
    .attr("dy", "0.35em")
    .style("font-size", "16px")
    .style("font-weight", "bold")
    .style("fill", (d) => sefirotInfo[d.id].color)
    .style("text-shadow", "0 0 3px white, 0 0 5px white");

  // אנימציית הופעה לספירות
  nodes
    .transition()
    .duration(1000)
    .delay((d, i) => i * 100)
    .style("opacity", 1);

  // הוספת אינטראקטיביות
  nodes
    .on("mouseover", function (event, d) {
      // הדגשת הקשרים
      lines
        .attr("stroke", function (l) {
          return l.source.id === d.id || l.target.id === d.id
            ? sefirotInfo[d.id].color
            : "rgba(0,0,0,0.15)";
        })
        .attr("stroke-width", function (l) {
          return l.source.id === d.id || l.target.id === d.id ? 4 : 2;
        });

      // אנימציית הספירה משופרת
      d3.select(this)
        .transition()
        .duration(300)
        .attr("transform", `translate(${d.x},${d.y}) scale(1.15)`);

      // הוספת זוהר לעיגול
      d3.select(this)
        .select("circle")
        .style("filter", "drop-shadow(0 0 8px rgba(255,255,255,0.8))");
    })
    .on("mouseout", function (event, d) {
      // החזרת הקווים למצב הרגיל
      lines.attr("stroke", "rgba(0,0,0,0.2)").attr("stroke-width", 2);

      // החזרת הספירה לגודל הרגיל
      d3.select(this)
        .transition()
        .duration(300)
        .attr("transform", `translate(${d.x},${d.y}) scale(1)`);
    })
    .on("click", function (event, d) {
      showModal(d.id);
    });

  // הוספת הנתיבות
  const pathsInfo = [
    {
      from: "כתר",
      to: "חכמה",
      letter: "א",
      tarot: "The Fool",
      angel: "מטטרון",
    },
    {
      from: "כתר",
      to: "בינה",
      letter: "ב",
      tarot: "The Magician",
      angel: "רזיאל",
    },
    {
      from: "חכמה",
      to: "בינה",
      letter: "ג",
      tarot: "The High Priestess",
      angel: "צפקיאל",
    },
    {
      from: "חכמה",
      to: "תפארת",
      letter: "ד",
      tarot: "The Empress",
      angel: "צדקיאל",
    },
    {
      from: "חכמה",
      to: "חסד",
      letter: "ה",
      tarot: "The Emperor",
      angel: "מיכאל",
    },
    {
      from: "בינה",
      to: "גבורה",
      letter: "ו",
      tarot: "The Hierophant",
      angel: "כמאל",
    },
    {
      from: "בינה",
      to: "תפארת",
      letter: "ז",
      tarot: "The Lovers",
      angel: "רפאל",
    },
    {
      from: "חסד",
      to: "גבורה",
      letter: "ח",
      tarot: "The Chariot",
      angel: "חניאל",
    },
    {
      from: "חסד",
      to: "תפארת",
      letter: "ט",
      tarot: "Strength",
      angel: "אוריאל",
    },
    {
      from: "חסד",
      to: "נצח",
      letter: "י",
      tarot: "The Hermit",
      angel: "מיכאל",
    },
    {
      from: "גבורה",
      to: "תפארת",
      letter: "כ",
      tarot: "Wheel of Fortune",
      angel: "גבריאל",
    },
    { from: "גבורה", to: "הוד", letter: "ל", tarot: "Justice", angel: "רפאל" },
    {
      from: "תפארת",
      to: "נצח",
      letter: "מ",
      tarot: "The Hanged Man",
      angel: "אוריאל",
    },
    { from: "תפארת", to: "הוד", letter: "נ", tarot: "Death", angel: "מיכאל" },
    {
      from: "תפארת",
      to: "יסוד",
      letter: "ס",
      tarot: "Temperance",
      angel: "גבריאל",
    },
    { from: "נצח", to: "הוד", letter: "ע", tarot: "The Devil", angel: "רפאל" },
    {
      from: "נצח",
      to: "יסוד",
      letter: "פ",
      tarot: "The Tower",
      angel: "הניאל",
    },
    { from: "הוד", to: "יסוד", letter: "צ", tarot: "The Star", angel: "מיכאל" },
    {
      from: "יסוד",
      to: "מלכות",
      letter: "ק",
      tarot: "The Moon",
      angel: "גבריאל",
    },
    { from: "נצח", to: "מלכות", letter: "ר", tarot: "The Sun", angel: "רפאל" },
    {
      from: "הוד",
      to: "מלכות",
      letter: "ש",
      tarot: "Judgement",
      angel: "אוריאל",
    },
    {
      from: "תפארת",
      to: "מלכות",
      letter: "ת",
      tarot: "The World",
      angel: "סנדלפון",
    },
  ];

  const pathsGroup = svg.append("g").attr("class", "paths");

  // יצירת הנתיבות
  const paths = pathsGroup
    .selectAll("g")
    .data(pathsInfo)
    .enter()
    .append("g")
    .attr("class", "path-group");

  // הוספת קווי הנתיבות
  paths
    .append("path")
    .attr("d", (d) => {
      const source = sefirotData.find((s) => s.id === d.from);
      const target = sefirotData.find((s) => s.id === d.to);
      return `M ${source.x} ${source.y} L ${target.x} ${target.y}`;
    })
    .attr("class", "path-line")
    .attr("stroke", "#666")
    .attr("stroke-width", 1)
    .attr("stroke-dasharray", "5,5");

  // הוספת האותיות העבריות
  paths
    .append("text")
    .attr("class", "path-letter")
    .attr("x", (d) => {
      const source = sefirotData.find((s) => s.id === d.from);
      const target = sefirotData.find((s) => s.id === d.to);
      return (source.x + target.x) / 2;
    })
    .attr("y", (d) => {
      const source = sefirotData.find((s) => s.id === d.from);
      const target = sefirotData.find((s) => s.id === d.to);
      return (source.y + target.y) / 2;
    })
    .text((d) => d.letter);
}

// פונקציה להצגת המודל
function showModal(sefirahId) {
  const info = sefirotInfo[sefirahId];
  const world = getWorldBySefira(sefirahId);

  const modalContent = document.querySelector(".modal-content");
  modalContent.innerHTML = `
        <span class="close-button">&times;</span>
        
        <!-- כותרת ראשית -->
        <div class="modal-header">
            <h2>${info.title}</h2>
            <p>${info.description}</p>
        </div>

        <!-- חלק עליון שמאל -->
        <div class="modal-section section-top-left">
            <h3>קשרים וחיבורים</h3>
            <div class="connection-grid">
                <div class="connection-item">
                    <strong>אות משם הוי"ה:</strong>
                    <span>${info.holyName}</span>
                </div>
                <div class="connection-item">
                    <strong>עולם:</strong>
                    <span>${world.name}</span>
                </div>
                <div class="connection-item">
                    <strong>כיוון:</strong>
                    <span>${getDirection(sefirahId)}</span>
                </div>
                <div class="connection-item">
                    <strong>פרצוף:</strong>
                    <span>${getPartzuf(sefirahId)}</span>
                </div>
            </div>
        </div>

        <!-- חלק עליון ימין -->
        <div class="modal-section section-top-right">
            <h3>קשר לגוף האדם</h3>
            <div class="body-grid">
                <div class="body-item">
                    <strong>איבר:</strong>
                    <span>${info.bodyConnection.part}</span>
                </div>
                <div class="body-item">
                    <strong>תפקוד:</strong>
                    <span>${info.bodyConnection.function}</span>
                </div>
                <div class="body-item">
                    <strong>צ'אקרה:</strong>
                    <span>${info.bodyConnection.chakra}</span>
                </div>
                <div class="body-item">
                    <strong>ריפוי:</strong>
                    <span>${info.bodyConnection.healing}</span>
                </div>
            </div>
        </div>

        <!-- חלק תחתון שמאל -->
        <div class="modal-section section-bottom-left">
            <h3>פנימיות הספירה</h3>
            ${
              sefirahId === "כתר"
                ? `<div class="pnimiut-aspects">
                    ${info.pnimiut.aspects
                      .map(
                        (aspect) => `
                        <div class="pnimiut-aspect">
                            <strong>${aspect.name}:</strong>
                            <p>${aspect.description}</p>
                        </div>
                    `
                      )
                      .join("")}
                </div>`
                : `<div class="pnimiut-content">
                    <h4>${info.pnimiut.title}</h4>
                    <p>${info.pnimiut.description}</p>
                    <div class="pnimiut-expression">
                        <strong>ביטוי:</strong> ${info.pnimiut.expression}
                    </div>
                </div>`
            }
        </div>

        <!-- חלק תחתון ימין -->
        <div class="modal-section section-bottom-right">
            <h3>מאפיינים</h3>
            <div class="attributes-list">
                ${Object.entries(info.attributes)
                  .map(
                    ([key, value]) => `
                    <div class="attribute-item">
                        <strong>${key}:</strong>
                        <span>${value}</span>
                    </div>
                `
                  )
                  .join("")}
            </div>
        </div>
    `;

  // הפעלת אנימציות
  const sections = document.querySelectorAll(".modal-section");
  sections.forEach((section, index) => {
    gsap.from(section, {
      duration: 0.5,
      opacity: 0,
      y: 20,
      delay: 0.1 * index,
      ease: "power2.out",
    });
  });

  modal.classList.add("show");

  // חיבור מחדש של כפתור הסגירה
  document.querySelector(".close-button").addEventListener("click", () => {
    modal.classList.remove("show");
  });
}

// הפעלת היצירה בטעינת העמוד
document.addEventListener("DOMContentLoaded", createTree);

// אנימציית פתיחת המודל
function animateModal(modal) {
  gsap.to(modal, {
    duration: 0.3,
    opacity: 1,
    scale: 1,
    ease: "power2.out",
  });
}

// עדכון הקוד הקיים של פתיחת המודל
document.querySelectorAll(".sefira").forEach((sefira) => {
  sefira.addEventListener("click", () => {
    const name = sefira.dataset.name;
    const info = sefirotInfo[name];

    modalTitle.textContent = info.title;
    modalDescription.textContent = info.description;

    const attributesList = document.getElementById("modal-attributes");
    attributesList.innerHTML = "";

    Object.entries(info.attributes).forEach(([key, value]) => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${key}:</strong> ${value}`;
      gsap.from(li, {
        duration: 0.3,
        x: -50,
        opacity: 0,
        delay: Math.random() * 0.2,
      });
      attributesList.appendChild(li);
    });

    modal.classList.add("show");
    animateModal(modal.querySelector(".modal-content"));

    // אפקט זוהר לספירה שנבחרה
    gsap.to(sefira.querySelector(".circle"), {
      duration: 0.5,
      boxShadow: `0 0 30px ${info.color}`,
      scale: 1.1,
      yoyo: true,
      repeat: 1,
    });
  });
});

// סגירת המודל
closeButton.addEventListener("click", () => {
  modal.classList.remove("show");
});

// סגירת המודל בלחיצה מחוץ לתוכן
modal.addEventListener("click", (e) => {
  if (e.target === modal) {
    modal.classList.remove("show");
  }
});

// סגירת המודל בלחיצה על ESC
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && modal.classList.contains("show")) {
    modal.classList.remove("show");
  }
});

// הוספה לקוד הקיים - הדגשת הספירות לפי העולמות
document.querySelectorAll(".world").forEach((world) => {
  world.addEventListener("mouseenter", () => {
    const worldName = world.dataset.world;
    const sefirotInWorld = getSefirotByWorld(worldName);

    // הדגשת הספירות הרלוונטיות
    d3.selectAll(".sefira-group").style("opacity", (d) =>
      sefirotInWorld.includes(d.id) ? 1 : 0.3
    );

    // הדגשת הקווים הרלוונטיים
    d3.selectAll("line").style("opacity", (l) =>
      sefirotInWorld.includes(l.source.id) &&
      sefirotInWorld.includes(l.target.id)
        ? 1
        : 0.1
    );
  });

  world.addEventListener("mouseleave", () => {
    // החזרת כל הספירות למצב הרגיל
    d3.selectAll(".sefira-group").style("opacity", 1);
    d3.selectAll("line").style("opacity", 1);
  });
});

// פונקציה המחזירה את הספירות השייכות לכל עולם
function getSefirotByWorld(worldName) {
  const worldsMap = {
    atzilut: ["כתר", "חכמה", "בינה"],
    briah: ["חסד", "גבורה", "תפארת"],
    yetzirah: ["נצח", "הוד", "יסוד"],
    asiah: ["מלכות"],
  };
  return worldsMap[worldName] || [];
}

// פונקציה המחזירה מידע על העולם לפי הספירה
function getWorldBySefira(sefirahId) {
  const worlds = {
    atzilut: {
      name: "אצילות",
      description: "עולם האלוקות הטהור, בו מתגלה האור האינסופי",
    },
    briah: {
      name: "בריאה",
      description: "עולם המחשבה והתובנה העליונה",
    },
    yetzirah: {
      name: "יצירה",
      description: "עולם הרגש והמידות",
    },
    asiah: {
      name: "עשייה",
      description: "עולם המעשה והגשמיות",
    },
  };

  if (["כתר", "חכמה", "בינה"].includes(sefirahId)) return worlds.atzilut;
  if (["חסד", "גבורה", "תפארת"].includes(sefirahId)) return worlds.briah;
  if (["נצח", "הוד", "יסוד"].includes(sefirahId)) return worlds.yetzirah;
  if (sefirahId === "מלכות") return worlds.asiah;
}

// פונקציה חדשה להצגת הקשרים בין המערכות
function showSystemConnections(sefirahId) {
  const info = sefirotInfo[sefirahId];
  const connections = {
    holyName: info.holyName,
    world: info.world,
    direction: getDirection(sefirahId),
    partzuf: getPartzuf(sefirahId),
  };

  // הוספת מידע על הקשרים למודל
  const connectionsDiv = document.createElement("div");
  connectionsDiv.className = "connections-container";
  connectionsDiv.innerHTML = `
        <h3>קשרים וחיבורים:</h3>
        <div class="connection-grid">
            <div class="connection-item">
                <strong>אות משם הוי"ה:</strong>
                <span>${connections.holyName}</span>
            </div>
            <div class="connection-item">
                <strong>עולם:</strong>
                <span>${connections.world}</span>
            </div>
            <div class="connection-item">
                <strong>כיוון:</strong>
                <span>${connections.direction}</span>
            </div>
            <div class="connection-item">
                <strong>פרצוף:</strong>
                <span>${connections.partzuf}</span>
            </div>
        </div>
    `;

  // הוספת החלק החדש למודל
  const modalBody = document.querySelector(".modal-body");
  modalBody.insertBefore(
    connectionsDiv,
    modalBody.querySelector(".attributes-container")
  );
}

// פונקציות עזר לקבלת מידע נוסף
function getDirection(sefirahId) {
  const directions = {
    כתר: "למעלה",
    חכמה: "ימין",
    בינה: "שמאל",
    חסד: "ימין",
    גבורה: "שמאל",
    תפארת: "אמצע",
    נצח: "ימין",
    הוד: "שמאל",
    יסוד: "אמצע",
    מלכות: "למטה",
  };
  return directions[sefirahId];
}

function getPartzuf(sefirahId) {
  const partzufim = {
    כתר: "אריך אנפין",
    חכמה: "אבא",
    בינה: "אמא",
    "חסד גבורה תפארת": "זעיר אנפין",
    מלכות: "נוקבא",
  };
  return partzufim[sefirahId] || "זעיר אנפין";
}
